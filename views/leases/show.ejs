<%- include('../partials/header') %>

<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 text-dark mb-0">
      <i class="fas fa-file-contract me-2"></i>Lease Details
    </h1>
    <div class="btn-group">
      <a href="/leases" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Leases
      </a>
      <a href="/leases/<%= lease.id %>/edit" class="btn btn-primary">
        <i class="fas fa-edit me-2"></i>Edit Lease
      </a>
      <% if (lease.status !== 'active') { %>
        <form action="/leases/<%= lease.id %>/activate" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-play me-2"></i>Activate
          </button>
        </form>
      <% } %>
      <button class="btn btn-outline-danger" onclick="confirmDelete()">
        <i class="fas fa-trash me-2"></i>Delete
      </button>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <% if (messages.success && messages.success.length > 0) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="fas fa-check-circle me-2"></i>
      <%= messages.success.join(', ') %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>
  
  <% if (messages.error && messages.error.length > 0) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <%= messages.error.join(', ') %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>

  <div class="row">
    <!-- Left Column - Property & Tenants -->
    <div class="col-lg-4">
      <!-- Property Information -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0">
            <i class="fas fa-building me-2"></i>Property
          </h5>
        </div>
        <div class="card-body">
          <% if (lease.property) { %>
            <h6>
              <a href="/properties/<%= lease.property.id %>" class="text-decoration-none">
                <%= lease.property.name || lease.property.address %>
              </a>
            </h6>
            <p class="text-muted mb-2">
              <%= lease.property.address %><br>
              <%= lease.property.city %>, <%= lease.property.state %> <%= lease.property.zipCode %>
            </p>
            <div class="row text-center">
              <div class="col-4">
                <small class="text-muted">Bedrooms</small>
                <div><%= lease.property.bedrooms || 'N/A' %></div>
              </div>
              <div class="col-4">
                <small class="text-muted">Bathrooms</small>
                <div><%= lease.property.bathrooms || 'N/A' %></div>
              </div>
              <div class="col-4">
                <small class="text-muted">Sq Ft</small>
                <div><%= lease.property.squareFootage || 'N/A' %></div>
              </div>
            </div>
          <% } else { %>
            <span class="text-muted">Property information not available</span>
          <% } %>
        </div>
      </div>

      <!-- Tenants Information -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0">
            <i class="fas fa-users me-2"></i>Tenants
          </h5>
        </div>
        <div class="card-body">
          <% 
            const tenants = [];
            if (lease.tenant1 && lease.tenant1.firstName && lease.tenant1.lastName) {
              tenants.push({...lease.tenant1, role: 'Primary'});
            }
            if (lease.tenant2 && lease.tenant2.firstName && lease.tenant2.lastName) {
              tenants.push({...lease.tenant2, role: 'Secondary'});
            }
            if (lease.tenant3 && lease.tenant3.firstName && lease.tenant3.lastName) {
              tenants.push({...lease.tenant3, role: 'Third'});
            }
            if (lease.tenant4 && lease.tenant4.firstName && lease.tenant4.lastName) {
              tenants.push({...lease.tenant4, role: 'Fourth'});
            }
          %>
          
          <% if (tenants.length > 0) { %>
            <% tenants.forEach((tenant, index) => { %>
              <div class="d-flex align-items-center mb-3 <%= index < tenants.length - 1 ? 'border-bottom pb-3' : '' %>">
                <div class="avatar-circle bg-primary text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                  <%= (tenant.firstName || '?').charAt(0) + (tenant.lastName || '?').charAt(0) %>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-1">
                    <a href="/tenants/<%= tenant.id %>" class="text-decoration-none">
                      <%= tenant.getFullName ? tenant.getFullName() : (tenant.firstName + ' ' + tenant.lastName) %>
                    </a>
                    <span class="badge bg-secondary ms-2"><%= tenant.role %></span>
                  </h6>
                  <div class="small text-muted">
                    <i class="fas fa-envelope me-1"></i><%= tenant.email || 'No email' %>
                  </div>
                  <% if (tenant.phone) { %>
                    <div class="small text-muted">
                      <i class="fas fa-phone me-1"></i><%= tenant.phone %>
                    </div>
                  <% } %>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <div class="text-center py-3">
              <i class="fas fa-user-slash text-muted mb-2"></i>
              <p class="text-muted">No tenants assigned to this lease</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Lease Status -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>Status
          </h5>
        </div>
        <div class="card-body text-center">
          <span class="badge fs-6 bg-<%= lease.status === 'active' ? 'success' : 
                                       lease.status === 'pending' ? 'warning' : 
                                       lease.status === 'expired' ? 'secondary' : 'danger' %>">
            <%= lease.status.charAt(0).toUpperCase() + lease.status.slice(1) %>
          </span>
          <div class="mt-2">
            <small class="text-muted">Type: <%= lease.leaseType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) %></small>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Lease Details -->
    <div class="col-lg-8">
      <!-- Lease Terms -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0">
            <i class="fas fa-calendar me-2"></i>Lease Terms
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <strong class="text-muted">Start Date:</strong>
              <div class="h6"><%= new Date(lease.startDate).toLocaleDateString() %></div>
            </div>
            <div class="col-md-6 mb-3">
              <strong class="text-muted">End Date:</strong>
              <div class="h6"><%= new Date(lease.endDate).toLocaleDateString() %></div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <strong class="text-muted">Duration:</strong>
              <div class="h6">
                <% 
                  const diffTime = new Date(lease.endDate) - new Date(lease.startDate);
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                  const diffMonths = Math.ceil(diffDays / 30.44);
                %>
                <%= diffMonths %> months (<%= diffDays %> days)
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <strong class="text-muted">Rent Due Day:</strong>
              <div class="h6"><%= lease.rentDueDay %><%= lease.rentDueDay == 1 ? 'st' : lease.rentDueDay == 2 ? 'nd' : lease.rentDueDay == 3 ? 'rd' : 'th' %> of each month</div>
            </div>
          </div>

          <% if (lease.signedDate) { %>
            <div class="row">
              <div class="col-md-6 mb-3">
                <strong class="text-muted">Signed Date:</strong>
                <div class="h6"><%= new Date(lease.signedDate).toLocaleDateString() %></div>
              </div>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Financial Summary -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0">
            <i class="fas fa-dollar-sign me-2"></i>Financial Summary
          </h5>
        </div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-primary mb-1">$<%= new Intl.NumberFormat().format(lease.monthlyRent) %></h4>
                <small class="text-muted">Monthly Rent</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-info mb-1">$<%= new Intl.NumberFormat().format(lease.totalLeaseValue || 0) %></h4>
                <small class="text-muted">Total Lease Value</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-success mb-1">$<%= new Intl.NumberFormat().format(lease.totalAmountPaid || 0) %></h4>
                <small class="text-muted">Amount Paid</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center">
                <h4 class="text-warning mb-1">$<%= new Intl.NumberFormat().format(lease.totalAmountRemaining || 0) %></h4>
                <small class="text-muted">Amount Remaining</small>
              </div>
            </div>
          </div>

          <!-- Payment Progress -->
          <% if (lease.totalLeaseValue && lease.totalAmountPaid !== null) { %>
            <% const progress = Math.max(0, Math.min(100, Math.round((lease.totalAmountPaid / lease.totalLeaseValue) * 100))) %>
            <div class="mb-3">
              <div class="d-flex justify-content-between mb-1">
                <span class="text-muted">Payment Progress</span>
                <span class="text-muted"><%= progress %>%</span>
              </div>
              <div class="progress" style="height: 10px;">
                <div class="progress-bar" style="width: <%= progress %>%;"></div>
              </div>
            </div>
          <% } %>

          <!-- Deposits & Fees -->
          <div class="row">
            <div class="col-md-4">
              <strong class="text-muted">Security Deposit:</strong>
              <div>$<%= new Intl.NumberFormat().format(lease.securityDeposit || 0) %></div>
            </div>
            <div class="col-md-4">
              <strong class="text-muted">Pet Deposit:</strong>
              <div>$<%= new Intl.NumberFormat().format(lease.petDeposit || 0) %></div>
            </div>
            <div class="col-md-4">
              <strong class="text-muted">Late Fee:</strong>
              <div>$<%= new Intl.NumberFormat().format(lease.lateFeeAmount || 0) %> after <%= lease.lateFeeDaysAfterDue || 5 %> days</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Invoices -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-file-invoice me-2"></i>Invoices
            <% if (lease.invoices && lease.invoices.length > 0) { %>
              <span class="badge bg-secondary ms-2"><%= lease.invoices.length %></span>
            <% } %>
          </h5>
          <a href="/invoices/new?lease=<%= lease.id %>" class="btn btn-sm btn-primary">
            <i class="fas fa-plus me-2"></i>New Invoice
          </a>
        </div>
        <div class="card-body p-0">
          <% if (lease.invoices && lease.invoices.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Invoice #</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Paid</th>
                    <th>Balance</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% lease.invoices.forEach(invoice => { %>
                    <tr>
                      <td>
                        <a href="/invoices/<%= invoice.id %>" class="text-decoration-none fw-bold">
                          <%= invoice.invoiceNumber %>
                        </a>
                        <% if (invoice.periodStart && invoice.periodEnd) { %>
                          <br><small class="text-muted">
                            <%= new Date(invoice.periodStart).toLocaleDateString() %> - 
                            <%= new Date(invoice.periodEnd).toLocaleDateString() %>
                          </small>
                        <% } %>
                      </td>
                      <td>
                        <div><%= new Date(invoice.invoiceDate).toLocaleDateString() %></div>
                        <small class="text-muted">
                          Due: <%= new Date(invoice.dueDate).toLocaleDateString() %>
                          <% if (new Date(invoice.dueDate) < new Date() && invoice.status !== 'paid') { %>
                            <span class="badge bg-danger ms-1">Overdue</span>
                          <% } %>
                        </small>
                      </td>
                      <td>
                        <span class="fw-bold">$<%= new Intl.NumberFormat().format(invoice.totalAmount) %></span>
                        <% if (invoice.rentAmount > 0) { %>
                          <br><small class="text-muted">Rent: $<%= new Intl.NumberFormat().format(invoice.rentAmount) %></small>
                        <% } %>
                        <% if (invoice.lateFeeAmount > 0) { %>
                          <br><small class="text-warning">Late Fee: $<%= new Intl.NumberFormat().format(invoice.lateFeeAmount) %></small>
                        <% } %>
                      </td>
                      <td>
                        <span class="fw-bold text-success">$<%= new Intl.NumberFormat().format(invoice.totalPaid || 0) %></span>
                        <% if (invoice.payments && invoice.payments.length > 0) { %>
                          <br><small class="text-muted"><%= invoice.payments.length %> payment(s)</small>
                        <% } %>
                      </td>
                      <td>
                        <span class="fw-bold text-<%= (invoice.balanceAmount || 0) > 0 ? 'danger' : 'success' %>">
                          $<%= new Intl.NumberFormat().format(invoice.balanceAmount || 0) %>
                        </span>
                      </td>
                      <td>
                        <span class="badge bg-<%= 
                          invoice.status === 'paid' ? 'success' : 
                          invoice.status === 'partially_paid' ? 'warning' : 
                          invoice.status === 'overdue' ? 'danger' : 
                          invoice.status === 'sent' ? 'info' : 
                          'light text-dark' 
                        %>">
                          <%= invoice.status.replace('_', ' ').toUpperCase() %>
                        </span>
                      </td>
                      <td>
                        <div class="dropdown">
                          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            Actions
                          </button>
                          <ul class="dropdown-menu">
                            <li>
                              <a class="dropdown-item" href="/invoices/<%= invoice.id %>">
                                <i class="fas fa-eye me-2"></i>View
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item" href="/invoices/<%= invoice.id %>/edit">
                                <i class="fas fa-edit me-2"></i>Edit
                              </a>
                            </li>
                            <% if (invoice.balanceAmount > 0) { %>
                              <li>
                                <a class="dropdown-item" href="/payments/new?invoice=<%= invoice.id %>">
                                  <i class="fas fa-credit-card me-2"></i>Record Payment
                                </a>
                              </li>
                            <% } %>
                            <% if (invoice.status === 'draft') { %>
                              <li><hr class="dropdown-divider"></li>
                              <li>
                                <form action="/invoices/<%= invoice.id %>/send" method="POST" style="display: inline;">
                                  <button type="submit" class="dropdown-item">
                                    <i class="fas fa-paper-plane me-2"></i>Send Invoice
                                  </button>
                                </form>
                              </li>
                            <% } %>
                          </ul>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            
            <!-- Invoice Summary -->
            <div class="card-footer bg-light">
              <div class="row text-center">
                <div class="col-md-3">
                  <small class="text-muted">Total Invoiced</small>
                  <div class="fw-bold text-primary">
                    $<%= new Intl.NumberFormat().format(
                      lease.invoices.reduce((sum, inv) => sum + parseFloat(inv.totalAmount || 0), 0)
                    ) %>
                  </div>
                </div>
                <div class="col-md-3">
                  <small class="text-muted">Total Paid</small>
                  <div class="fw-bold text-success">
                    $<%= new Intl.NumberFormat().format(
                      lease.invoices.reduce((sum, inv) => sum + parseFloat(inv.totalPaid || 0), 0)
                    ) %>
                  </div>
                </div>
                <div class="col-md-3">
                  <small class="text-muted">Outstanding</small>
                  <div class="fw-bold text-danger">
                    $<%= new Intl.NumberFormat().format(
                      lease.invoices.reduce((sum, inv) => sum + parseFloat(inv.balanceAmount || 0), 0)
                    ) %>
                  </div>
                </div>
                <div class="col-md-3">
                  <small class="text-muted">Overdue</small>
                  <div class="fw-bold text-warning">
                    $<%= new Intl.NumberFormat().format(
                      lease.invoices
                        .filter(inv => new Date(inv.dueDate) < new Date() && inv.status !== 'paid')
                        .reduce((sum, inv) => sum + parseFloat(inv.balanceAmount || 0), 0)
                    ) %>
                  </div>
                </div>
              </div>
            </div>
          <% } else { %>
            <div class="text-center py-5">
              <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No Invoices Yet</h5>
              <p class="text-muted">Create the first invoice for this lease to track rent and charges.</p>
              <a href="/invoices/new?lease=<%= lease.id %>" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create First Invoice
              </a>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Additional Information -->
      <% if (lease.notes) { %>
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-white border-bottom">
            <h5 class="mb-0">
              <i class="fas fa-sticky-note me-2"></i>Notes
            </h5>
          </div>
          <div class="card-body">
            <p class="mb-0"><%= lease.notes %></p>
          </div>
        </div>
      <% } %>

      <!-- Quick Actions -->
      <div class="card shadow-sm">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0">
            <i class="fas fa-tools me-2"></i>Quick Actions
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <a href="/invoices/new?lease=<%= lease.id %>" class="btn btn-outline-primary w-100">
                <i class="fas fa-file-invoice me-2"></i>Create Invoice
              </a>
            </div>
            <div class="col-md-6 mb-3">
              <a href="/payments/new?lease=<%= lease.id %>" class="btn btn-outline-success w-100">
                <i class="fas fa-credit-card me-2"></i>Record Payment
              </a>
            </div>
            <div class="col-md-6 mb-3">
              <a href="/leases/<%= lease.id %>/edit" class="btn btn-outline-warning w-100">
                <i class="fas fa-edit me-2"></i>Edit Lease
              </a>
            </div>
            <div class="col-md-6 mb-3">
              <button class="btn btn-outline-info w-100" onclick="window.print()">
                <i class="fas fa-print me-2"></i>Print Lease
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this lease?</p>
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          This action cannot be undone. The lease and all related data will be permanently removed.
        </div>
        <% if (lease.property) { %>
          <div class="alert alert-info">
            <strong>Property:</strong> <%= lease.property.name || lease.property.address %>
          </div>
        <% } %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="/leases/<%= lease.id %>" method="POST" style="display: inline;">
          <input type="hidden" name="_method" value="DELETE">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash me-2"></i>Delete Lease
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function confirmDelete() {
  new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>

<%- include('../partials/footer') %> 